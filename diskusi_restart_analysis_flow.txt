# Diskusi Restart Analysis Flow - LIMS System

## Problem Statement
User melaporkan bahwa ketika klik button "Restart Analysis", seluruh flow status history berubah/regenerate, padahal yang diharapkan hanya menambahkan status "Restart Analysis" saja.

## Expected Flow
### Original Analysis Flow:
1. Pending (Sample submitted)
2. In Progress (Analysis started)
3. Analysis Completed (Analysis done)
4. Reviewed (QC Manager review)
5. Approved (Original approval)

### Restart Analysis Flow:
6. Restart Analysis (Decision to restart - triggered by QC Manager)
7. In Progress (Restart) (Re-analysis started)
8. Analysis Completed (Restart) (Re-analysis done)
9. Review (Restart) (QC Manager review restart results)
10. Final Decision (Approved/Rejected - final decision)

## Root Cause Analysis

### Problem 1: Status Display Issue
- Sample menampilkan status "In Progress" padahal sudah "Analysis Completed"
- **Cause**: Database inconsistency - status_id tidak sesuai dengan status string
- **Solution**:
  - Fix AnalysisPage.php untuk update status_id yang benar
  - Update existing data di database
  - Clear cache

### Problem 2: Restart Analysis Generate All Statuses
- Ketika klik "Restart Analysis", sistem generate semua status restart sekaligus
- **Status yang muncul**: Pending -> In progress -> Analysis Completed -> Approved -> In progress(Restart) -> Analysis Completed (Restart) -> Restart Analysis -> Reviewed (Restart) -> Approved (Restart)
- **Expected**: Hanya menambahkan "Restart Analysis"

**Root Cause**:
- buildStatusHistory() logic terlalu "smart" - assumption-based instead of timestamp-based
- restartAnalysis() method langsung ubah ke 'in_progress' + overwrite timestamps

## Solutions Implemented

### 1. Fix buildStatusHistory() Logic
**Before**: Generate semua status restart berdasarkan assumption
```php
// Analysis restart detection
$showRestart = false;
$hasRestartStatus = in_array($this->sample->status, ['restart_analysis', 'in_progress_restart']);
// ... generate all restart events
```

**After**: Hanya tampilkan status yang benar-benar terjadi
```php
// Only add events that actually happened (have timestamps)

// Restart analysis status - only if current status is restart_analysis
if ($this->sample->status === 'restart_analysis') {
    $events[] = [
        'time' => $this->sample->updated_at,
        'status' => 'Restart Analysis',
        'analyst' => 'QC Manager',
        'type' => 'restart_analysis'
    ];
}
```

### 2. Fix restartAnalysis() Method
**Before**: Langsung ubah ke 'in_progress' + overwrite analysis_started_at
```php
'status' => 'in_progress',
'analysis_started_at' => $now,
```

**After**: Hanya ubah ke 'restart_analysis' + preserve timestamps
```php
'status' => 'restart_analysis',
// DO NOT change any timestamps
```

### 3. Database Status Verification
Status yang diperlukan di database:
```sql
9	restart_analysis	Restart Analysis	Analysis has been restarted for this sample	#F59E0B	7	1
10	in_progress_restart	In Progress (Restart)	Sample is being re-analyzed	#3B82F6	8	1
```

Status sudah ada via StatusSeeder.

## Technical Details

### Files Modified:
1. **ResultsReviewPage.php**
   - buildStatusHistory() method: Simplified logic, timestamp-based
   - restartAnalysis() method: Use 'restart_analysis' status instead of 'in_progress'

2. **AnalysisPage.php**
   - Fixed status_id update untuk analysis_completed

3. **Database**
   - Updated inconsistent status_id data
   - Verified StatusSeeder data

### Color Consistency Fixed:
- Reviewed status: Purple (bg-purple-100 text-purple-800) - consistent across all pages
- Status history modal: Fixed missing status_color in events
- All status colors now match StatusSeeder definitions

## Expected Behavior After Fix:

### When Click "Restart Analysis":
- Status history hanya menambah: "Restart Analysis"
- Tidak ada status lain yang auto-generate
- Original flow tetap intact

### Subsequent Manual Steps:
- Analyst start analysis → "In Progress (Restart)"
- Analysis selesai → "Analysis Completed (Restart)"
- QC Review → "Review (Restart)"
- Final decision → "Approved/Rejected (Restart)"

## Key Principles Applied:
1. **Timestamp-based logic**: Hanya tampilkan yang benar-benar terjadi
2. **Preserve original data**: Jangan overwrite timestamps existing
3. **Explicit status progression**: Setiap step harus manual/explicit
4. **Database consistency**: status dan status_id harus sync

## Files Location:
- C:\laragon\www\LIMS\app\Livewire\ResultsReviewPage.php
- C:\laragon\www\LIMS\app\Livewire\AnalysisPage.php
- C:\laragon\www\LIMS\database\seeders\StatusSeeder.php
- C:\laragon\www\LIMS\resources\views\livewire\results-review-page.blade.php
- C:\laragon\www\LIMS\resources\views\livewire\sample-rawmat-submission.blade.php

## Next Steps:
1. Test restart analysis button - should only add "Restart Analysis" status
2. Verify original flow preservation
3. Test subsequent manual progression through restart flow
4. Monitor for any edge cases or regressions

---
Generated: 2025-09-22
Status: Implementation Complete, Ready for Testing