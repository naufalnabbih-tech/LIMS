// LIMS Database Schema
// Generated from Laravel Migrations
// Use this at https://dbdiagram.io/

Project LIMS {
  database_type: 'MySQL'
  Note: 'Laboratory Information Management System - Database Schema'
}

// ========================================
// CORE TABLES - User Management
// ========================================

Table roles {
  id bigint [pk, increment]
  name varchar(255) [unique, not null]
  display_name varchar(255) [not null]
  description text [null]
  permissions json [null]
  is_active boolean [default: true]
  created_at timestamp [null]
  updated_at timestamp [null]

  Note: 'User roles and permissions'
}

Table users {
  id bigint [pk, increment]
  name varchar(255) [not null]
  email varchar(255) [unique, not null]
  role_id bigint [null, ref: > roles.id]
  email_verified_at timestamp [null]
  password varchar(255) [not null]
  two_factor_secret text [null]
  two_factor_recovery_codes text [null]
  two_factor_confirmed_at timestamp [null]
  remember_token varchar(100) [null]
  created_at timestamp [null]
  updated_at timestamp [null]

  Note: 'System users including analysts, QC managers, etc.'
}

Table statuses {
  id bigint [pk, increment]
  name varchar(255) [unique, not null]
  display_name varchar(255) [not null]
  description text [null]
  color varchar(7) [null]
  sort_order int [default: 0]
  is_active boolean [default: true]
  created_at timestamp [null]
  updated_at timestamp [null]

  Note: 'Sample status definitions (pending, in_progress, approved, etc.)'
}

// ========================================
// RAW MATERIAL MODULE
// ========================================

Table raw_mat_categories {
  id bigint [pk, increment]
  name varchar(255) [not null]
  created_at timestamp [null]
  updated_at timestamp [null]

  Note: 'Categories for raw materials'
}

Table raw_mats {
  id bigint [pk, increment]
  name varchar(255) [not null]
  category_id bigint [not null, ref: > raw_mat_categories.id]
  created_at timestamp [null]
  updated_at timestamp [null]

  Note: 'Raw material master data'
}

Table references {
  id bigint [pk, increment]
  name varchar(255) [not null]
  rawmat_id bigint [not null, ref: > raw_mats.id]
  created_at timestamp [null]
  updated_at timestamp [null]

  Note: 'Reference standards for raw materials'
}

Table specifications {
  id bigint [pk, increment]
  name varchar(255) [not null]
  created_at timestamp [null]
  updated_at timestamp [null]

  Note: 'Specification parameters for testing'
}

Table reference_specification {
  id bigint [pk, increment]
  reference_id bigint [not null, ref: > references.id]
  specification_id bigint [not null, ref: > specifications.id]
  operator enum('>=', '<=', '==', '-', 'contains', 'should_be') [default: '==']
  value float [null]
  max_value float [null]
  created_at timestamp [null]
  updated_at timestamp [null]

  Indexes {
    (reference_id, specification_id) [unique]
  }

  Note: 'Junction table linking references to their specifications'
}

Table raw_material_samples {
  id bigint [pk, increment]
  category_id bigint [not null, ref: > raw_mat_categories.id]
  raw_mat_id bigint [not null, ref: > raw_mats.id]
  reference_id bigint [null, ref: > references.id]
  supplier varchar(255) [not null]
  batch_lot varchar(255) [not null]
  vehicle_container_number varchar(255) [not null]
  has_coa boolean [default: false]
  coa_file_path varchar(255) [null]
  submission_time datetime [not null]
  entry_time datetime [default: `CURRENT_TIMESTAMP`]
  submitted_by bigint [not null, ref: > users.id]

  // Status tracking
  status varchar(50) [null]
  status_id bigint [null, ref: > statuses.id]

  // Analysis tracking
  analysis_method enum('individual', 'joint') [null]
  primary_analyst_id bigint [null, ref: > users.id]
  secondary_analyst_id bigint [null, ref: > users.id]
  analysis_started_at datetime [null]
  analysis_completed_at datetime [null]
  analysis_results json [null]

  // Review & Approval tracking
  reviewed_at datetime [null]
  reviewed_by bigint [null, ref: > users.id]
  approved_at datetime [null]
  approved_by bigint [null, ref: > users.id]
  rejected_at timestamp [null]
  rejected_by bigint [null, ref: > users.id]

  // Handover tracking
  handover_to_analyst_id bigint [null, ref: > users.id]
  handover_notes text [null]
  handover_submitted_by bigint [null, ref: > users.id]
  handover_submitted_at timestamp [null]
  handover_taken_by bigint [null, ref: > users.id]
  handover_taken_at timestamp [null]

  // Original analyst tracking (for handover history)
  original_primary_analyst_id bigint [null, ref: > users.id]
  original_secondary_analyst_id bigint [null, ref: > users.id]
  original_analysis_method varchar(255) [null]

  notes text [null]
  created_at timestamp [null]
  updated_at timestamp [null]

  Note: 'Raw material sample submissions and analysis tracking'
}

Table analysis_results {
  id bigint [pk, increment]
  sample_rawmat_id bigint [not null, ref: > raw_material_samples.id]
  specification_id bigint [not null, ref: > specifications.id]
  result_value varchar(255) [null]
  status enum('pending', 'completed', 'passed', 'failed') [default: 'pending']
  tested_by varchar(255) [null]
  tested_at timestamp [null]
  notes text [null]
  created_at timestamp [null]
  updated_at timestamp [null]

  Indexes {
    (sample_rawmat_id, specification_id) [unique]
  }

  Note: 'Detailed analysis results for each specification'
}

// ========================================
// SOLDER MODULE
// ========================================

Table solder_categories {
  id bigint [pk, increment]
  name varchar(255) [not null]
  created_at timestamp [null]
  updated_at timestamp [null]

  Note: 'Categories for solder materials'
}

Table solders {
  id bigint [pk, increment]
  name varchar(255) [not null]
  category_id bigint [not null, ref: > solder_categories.id]
  created_at timestamp [null]
  updated_at timestamp [null]

  Note: 'Solder material master data'
}

Table solder_references {
  id bigint [pk, increment]
  name varchar(255) [not null]
  solder_id bigint [not null, ref: > solders.id]
  created_at timestamp [null]
  updated_at timestamp [null]

  Note: 'Reference standards for solders'
}

Table solder_reference_specification {
  id bigint [pk, increment]
  reference_id bigint [not null, ref: > solder_references.id]
  specification_id bigint [not null, ref: > specifications.id]
  operator enum('>=', '<=', '==', '-', 'contains', 'should_be') [default: '==']
  value float [null]
  max_value float [null]
  created_at timestamp [null]
  updated_at timestamp [null]

  Indexes {
    (reference_id, specification_id) [unique]
  }

  Note: 'Junction table linking solder references to specifications'
}

Table solder_samples {
  id bigint [pk, increment]
  category_id bigint [not null, ref: > solder_categories.id]
  solder_id bigint [not null, ref: > solders.id]
  reference_id bigint [null, ref: > solder_references.id]
  supplier varchar(255) [not null]
  batch_lot varchar(255) [not null]
  vehicle_container_number varchar(255) [not null]
  has_coa boolean [default: false]
  coa_file_path varchar(255) [null]
  submission_time datetime [not null]
  entry_time datetime [default: `CURRENT_TIMESTAMP`]
  submitted_by bigint [not null, ref: > users.id]
  status enum('pending', 'submitted', 'in_progress', 'analysis_completed', 'reviewed', 'approved', 'rejected') [default: 'pending']
  notes text [null]

  // Analysis tracking
  analysis_method varchar(255) [null]
  primary_analyst_id bigint [null, ref: > users.id]
  secondary_analyst_id bigint [null, ref: > users.id]
  analysis_started_at datetime [null]
  analysis_completed_at datetime [null]
  analysis_results json [null]

  // Review & Approval tracking
  reviewed_at datetime [null]
  reviewed_by bigint [null, ref: > users.id]
  approved_at datetime [null]
  approved_by bigint [null, ref: > users.id]

  created_at timestamp [null]
  updated_at timestamp [null]

  Note: 'Solder sample submissions and analysis tracking'
}

Table test_results {
  id bigint [pk, increment]
  sample_id bigint [not null, ref: > solder_samples.id]
  specification_id bigint [not null, ref: > specifications.id]
  result_value varchar(255) [null]
  status enum('pending', 'completed', 'passed', 'failed') [default: 'pending']
  tested_by varchar(255) [null]
  tested_at timestamp [null]
  notes text [null]
  created_at timestamp [null]
  updated_at timestamp [null]

  Indexes {
    (sample_id, specification_id) [unique]
  }

  Note: 'Detailed test results for solder samples'
}

// ========================================
// INSTRUMENTS MODULE
// ========================================

Table instruments {
  id bigint [pk, increment]
  name varchar(255) [not null]
  description text [null]
  created_at timestamp [null]
  updated_at timestamp [null]

  Note: 'Laboratory instruments master data'
}

Table instrument_conditions {
  id bigint [pk, increment]
  instrument_id bigint [not null, ref: > instruments.id]
  shift varchar(255) [not null]
  time time [not null]
  date date [not null]
  operator_name varchar(255) [null]
  condition enum('good', 'damaged') [not null]
  description text [null]
  created_at timestamp [null]
  updated_at timestamp [null]

  Note: 'Instrument condition tracking per shift'
}

Table thermohygrometers {
  id bigint [pk, increment]
  name varchar(255) [not null]
  description text [null]
  created_at timestamp [null]
  updated_at timestamp [null]

  Note: 'Thermohygrometer devices master data'
}

Table thermohygrometer_conditions {
  id bigint [pk, increment]
  thermohygrometer_id bigint [not null, ref: > thermohygrometers.id]
  shift varchar(255) [not null]
  time time [not null]
  date date [not null]
  operator_name varchar(255) [null]
  temperature float [null]
  humidity float [null]
  condition enum('good', 'damaged') [not null]
  description text [null]
  created_at timestamp [null]
  updated_at timestamp [null]

  Note: 'Thermohygrometer readings and condition tracking'
}

// ========================================
// RELATIONSHIPS SUMMARY
// ========================================

// User & Role relationships
Ref: users.role_id > roles.id [delete: set null]

// Raw Material Module relationships
Ref: raw_mats.category_id > raw_mat_categories.id [delete: cascade]
Ref: references.rawmat_id > raw_mats.id [delete: cascade]
Ref: reference_specification.reference_id > references.id [delete: cascade]
Ref: reference_specification.specification_id > specifications.id [delete: cascade]

// Raw Material Samples - Core relationships
Ref: raw_material_samples.category_id > raw_mat_categories.id [delete: cascade]
Ref: raw_material_samples.raw_mat_id > raw_mats.id [delete: cascade]
Ref: raw_material_samples.reference_id > references.id [delete: set null]
Ref: raw_material_samples.submitted_by > users.id [delete: cascade]
Ref: raw_material_samples.status_id > statuses.id [delete: restrict]

// Raw Material Samples - Analyst relationships
Ref: raw_material_samples.primary_analyst_id > users.id [delete: set null]
Ref: raw_material_samples.secondary_analyst_id > users.id [delete: set null]
Ref: raw_material_samples.reviewed_by > users.id [delete: set null]
Ref: raw_material_samples.approved_by > users.id [delete: set null]
Ref: raw_material_samples.rejected_by > users.id

// Raw Material Samples - Handover relationships
Ref: raw_material_samples.handover_to_analyst_id > users.id [delete: set null]
Ref: raw_material_samples.handover_submitted_by > users.id [delete: set null]
Ref: raw_material_samples.handover_taken_by > users.id [delete: set null]
Ref: raw_material_samples.original_primary_analyst_id > users.id [delete: set null]
Ref: raw_material_samples.original_secondary_analyst_id > users.id [delete: set null]

// Analysis Results relationships
Ref: analysis_results.sample_rawmat_id > raw_material_samples.id [delete: cascade]
Ref: analysis_results.specification_id > specifications.id [delete: cascade]

// Solder Module relationships
Ref: solders.category_id > solder_categories.id [delete: cascade]
Ref: solder_references.solder_id > solders.id [delete: cascade]
Ref: solder_reference_specification.reference_id > solder_references.id [delete: cascade]
Ref: solder_reference_specification.specification_id > specifications.id [delete: cascade]

// Solder Samples relationships
Ref: solder_samples.category_id > solder_categories.id [delete: cascade]
Ref: solder_samples.solder_id > solders.id [delete: cascade]
Ref: solder_samples.reference_id > solder_references.id [delete: set null]
Ref: solder_samples.submitted_by > users.id [delete: cascade]
Ref: solder_samples.primary_analyst_id > users.id [delete: set null]
Ref: solder_samples.secondary_analyst_id > users.id [delete: set null]
Ref: solder_samples.reviewed_by > users.id [delete: set null]
Ref: solder_samples.approved_by > users.id [delete: set null]

// Test Results relationships
Ref: test_results.sample_id > solder_samples.id [delete: cascade]
Ref: test_results.specification_id > specifications.id [delete: cascade]

// Instruments relationships
Ref: instrument_conditions.instrument_id > instruments.id [delete: cascade]
Ref: thermohygrometer_conditions.thermohygrometer_id > thermohygrometers.id [delete: cascade]
