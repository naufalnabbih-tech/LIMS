================================================================================
DOKUMENTASI PERUBAHAN - LIMS REFERENCE MANAGEMENT
Tanggal: 31 Oktober 2025
================================================================================

RINGKASAN
---------
Implementasi dukungan untuk tiga tipe operator berbeda dengan tipe data yang
sesuai pada fitur Reference Management:
1. Operator numerik (>=, <=, ==) - menyimpan nilai numerik
2. Operator range (-) - menyimpan array JSON dengan pasangan min-max
3. Operator should_be - menyimpan nilai teks/string


MASALAH YANG DISELESAIKAN
--------------------------

1. PSR-4 Autoloading Error
   - Error: Class App\Livewire\RawMatCategory tidak sesuai dengan nama file
   - Penyebab: Nama file RawmatCategory.php (huruf 'm' kecil) tidak cocok
     dengan nama class RawMatCategory (huruf 'M' besar)
   - Solusi: Rename file dari RawmatCategory.php ke RawMatCategory.php

2. Data Truncation Error untuk Operator should_be
   - Error: SQLSTATE[01000]: Warning: 1265 Data truncated for column 'value'
   - Penyebab: Kolom 'value' bertipe DECIMAL tidak bisa menyimpan string
   - Solusi: Menambahkan kolom 'spec_value' bertipe VARCHAR untuk nilai teks

3. Data Truncation Error untuk Operator Range
   - Error: SQLSTATE[01000]: Warning: 1265 Data truncated for column 'value'
   - Penyebab: Kolom 'value' bertipe DECIMAL tidak bisa menyimpan JSON array
   - Solusi: Menambahkan kolom 'value_json' bertipe TEXT untuk data range

4. Range Values Tidak Tampil di Tabel
   - Masalah: Data range berhasil disimpan ke database tapi tidak ditampilkan
   - Penyebab: Kolom 'value_json' tidak di-load oleh model relationship
   - Solusi: Menambahkan 'value_json' ke dalam withPivot() di model Reference


STRUKTUR DATABASE
-----------------

Tabel: reference_specification (pivot table)
Kolom-kolom yang digunakan:
- value (DECIMAL) - untuk operator numerik (>=, <=, ==)
- value_json (TEXT) - untuk operator range (-)
- spec_value (VARCHAR) - untuk operator should_be
- operator (VARCHAR) - menyimpan jenis operator
- max_value (DECIMAL) - untuk keperluan lain (tidak dimodifikasi)


FILE-FILE YANG DIMODIFIKASI
----------------------------

1. DATABASE MIGRATIONS

   a. File: database/migrations/2025_10_31_135003_add_spec_value_to_specifications_table.php
      Deskripsi: Menambahkan kolom spec_value untuk operator should_be

      Perubahan:
      - Menambahkan kolom: $table->string('spec_value')->nullable()->after('max_value')
      - Tipe data: VARCHAR (string)
      - Posisi: Setelah kolom max_value

   b. File: database/migrations/2025_10_31_153221_add_value_json_to_reference_specification_table.php
      Deskripsi: Menambahkan kolom value_json untuk operator range

      Perubahan:
      - Menambahkan kolom: $table->text('value_json')->nullable()->after('value')
      - Tipe data: TEXT
      - Posisi: Setelah kolom value


2. MODEL

   File: app/Models/Reference.php
   Baris: 21-32

   Perubahan:
   - Menambahkan 'value_json' ke dalam withPivot() method

   Kode Sebelum:
   ```php
   public function specificationsManytoMany()
   {
       return $this->belongsToMany(Specification::class, 'reference_specification', 'reference_id', 'specification_id')
           ->withPivot(
               'value',
               'operator',
               'max_value',
               'spec_value'
           )
           ->withTimestamps();
   }
   ```

   Kode Sesudah:
   ```php
   public function specificationsManytoMany()
   {
       return $this->belongsToMany(Specification::class, 'reference_specification', 'reference_id', 'specification_id')
           ->withPivot(
               'value',
               'value_json',
               'operator',
               'max_value',
               'spec_value'
           )
           ->withTimestamps();
   }
   ```

   Alasan: Agar kolom value_json dapat diakses melalui $spec->pivot->value_json


3. LIVEWIRE COMPONENT

   File: app/Livewire/Reference.php

   a. Baris 35: Menambahkan Property Baru
      ```php
      public $specificationTextValues = []; // Array untuk menyimpan nilai teks operator should_be
      ```

   b. Baris 84-85: Update Validation Rules
      Menambahkan validasi untuk operator should_be:
      ```php
      } elseif ($operator === 'should_be') {
          $rules["specificationTextValues.{$specId}"] = 'required|string';
      ```

   c. Baris 191-200: Update openEditModal Method
      Menambahkan logika load data untuk ketiga tipe operator:
      ```php
      if ($spec->pivot->operator === '-') {
          // Parse stored range data from value_json column
          $rangeData = json_decode($spec->pivot->value_json, true);
          $this->specificationRanges[$spec->id] = $rangeData ?: [['min' => '', 'max' => '']];
      } elseif ($spec->pivot->operator === 'should_be') {
          // Load text value for should_be operator from spec_value column
          $this->specificationTextValues[$spec->id] = $spec->pivot->spec_value ?? '';
      } else {
          $this->specificationValues[$spec->id] = $spec->pivot->value ?? '';
      }
      ```

   d. Baris 219: Update resetForm Method
      Menambahkan reset untuk specificationTextValues:
      ```php
      $this->specificationTextValues = [];
      ```

   e. Baris 282-305: Update store Method
      Menyimpan data ke kolom yang sesuai berdasarkan operator:
      - Operator range (-): simpan ke value_json
      - Operator should_be: simpan ke spec_value
      - Operator numerik: simpan ke value

      ```php
      if ($operator === '-') {
          $syncData[$specId] = [
              'value' => null,
              'value_json' => json_encode($cleanRanges),
              'spec_value' => null,
              'max_value' => null,
              'operator' => $operator
          ];
      } elseif ($operator === 'should_be') {
          $syncData[$specId] = [
              'value' => null,
              'value_json' => null,
              'spec_value' => $this->specificationTextValues[$specId] ?? '',
              'max_value' => null,
              'operator' => $operator
          ];
      } else {
          $syncData[$specId] = [
              'value' => $this->specificationValues[$specId] ?? '',
              'value_json' => null,
              'spec_value' => null,
              'max_value' => null,
              'operator' => $operator
          ];
      }
      ```

   f. Baris 366-389: Update update Method
      Logika yang sama seperti store method untuk update data

   g. Baris 419-420: Update toggleSpecification Method
      Inisialisasi specificationTextValues saat specification dipilih:
      ```php
      $this->specificationTextValues[$specificationId] = '';
      ```

   h. Baris 436-442: Update updatedSpecificationOperators Method
      Menambahkan handling untuk operator should_be:
      ```php
      } elseif ($value === 'should_be') {
          // When switching to should_be operator, initialize text value
          unset($this->specificationRanges[$key]);
          unset($this->specificationValues[$key]);
          if (!isset($this->specificationTextValues[$key])) {
              $this->specificationTextValues[$key] = '';
          }
      ```


4. BLADE VIEW

   File: resources/views/livewire/reference.blade.php

   a. Baris 147-185: Update Display Logic di Tabel
      Menampilkan data sesuai dengan tipe operator:

      ```blade
      @if ($spec->pivot->operator === '-')
          @php
              $rawJson = $spec->pivot->value_json;
              $ranges = [];

              if (!empty($rawJson)) {
                  $ranges = json_decode($rawJson, true);
                  if (json_last_error() !== JSON_ERROR_NONE) {
                      $ranges = [];
                  }
              }
          @endphp
          @if (!empty($ranges) && is_array($ranges))
              <div class="flex flex-wrap gap-1">
                  @foreach ($ranges as $range)
                      @if (is_array($range))
                          <span class="inline-flex items-center rounded-md bg-blue-100 px-2 py-1 text-xs font-medium text-blue-800">
                              {{ $range['min'] ?? 'N/A' }} - {{ $range['max'] ?? 'N/A' }}
                          </span>
                      @endif
                  @endforeach
              </div>
          @else
              {{-- DEBUG: Uncomment untuk debug --}}
              <div class="text-xs text-red-500">
                  Raw: {{ $spec->pivot->value_json }}<br>
                  Decoded: {{ json_encode($ranges) }}<br>
                  Type: {{ gettype($ranges) }}<br>
                  Empty: {{ empty($ranges) ? 'yes' : 'no' }}
              </div>
              <span class="text-gray-500 italic">Range (No data)</span>
          @endif
      @elseif ($spec->pivot->operator === 'should_be')
          <span>{{ $spec->pivot->spec_value ?? 'N/A' }}</span>
      @else
          <span>{{ $spec->pivot->value ?? 'N/A' }}</span>
      @endif
      ```

      Fitur:
      - Menampilkan range dengan badge biru
      - Menampilkan spec_value untuk should_be
      - Menampilkan value untuk operator numerik
      - Mode debug untuk troubleshooting (baris 173-178)

   b. Baris 399-417 (Add Modal) & 616-634 (Edit Modal): Update Input Fields
      Menambahkan conditional input untuk should_be:

      ```blade
      @if (isset($specificationOperators[$specId]) && $specificationOperators[$specId] === 'should_be')
          <input type="text"
              wire:model="specificationTextValues.{{ $specId }}"
              placeholder="Enter text value for {{ $spec->name }}"
              class="@error('specificationTextValues.' . $specId) border-red-500 @else border-gray-300 @enderror w-full rounded-lg border px-3 py-2 text-sm shadow-sm">
          @error('specificationTextValues.' . $specId)
              <p class="mt-1 text-xs text-red-500">{{ $message }}</p>
          @enderror
      @else
          <input type="number" step="any"
              wire:model="specificationValues.{{ $specId }}"
              placeholder="Enter numeric value for {{ $spec->name }}"
              class="@error('specificationValues.' . $specId) border-red-500 @else border-gray-300 @enderror w-full rounded-lg border px-3 py-2 text-sm shadow-sm">
          @error('specificationValues.' . $specId)
              <p class="mt-1 text-xs text-red-500">{{ $message }}</p>
          @enderror
      @endif
      ```

      Fitur:
      - Input text untuk operator should_be
      - Input number untuk operator numerik
      - Error handling untuk masing-masing input


CARA MENJALANKAN MIGRATION
---------------------------

1. Jalankan migration untuk menambahkan kolom spec_value:
   php artisan migrate

   File: 2025_10_31_135003_add_spec_value_to_specifications_table.php

2. Jalankan migration untuk menambahkan kolom value_json:
   php artisan migrate

   File: 2025_10_31_153221_add_value_json_to_reference_specification_table.php


TESTING
-------

1. Test Operator should_be:
   - Pilih specification
   - Pilih operator "should_be"
   - Input akan berubah menjadi text input
   - Masukkan nilai teks (contoh: "Clear", "Transparent")
   - Save - data akan masuk ke kolom spec_value

2. Test Operator Range (-):
   - Pilih specification
   - Pilih operator "-" (range)
   - Input range akan muncul (min - max)
   - Dapat menambah multiple range dengan tombol "Add Range"
   - Save - data akan masuk ke kolom value_json sebagai JSON array

3. Test Operator Numerik (>=, <=, ==):
   - Pilih specification
   - Pilih operator numerik
   - Input akan menjadi number input
   - Masukkan nilai angka
   - Save - data akan masuk ke kolom value


NOTES PENTING
--------------

1. Mode Debug (Optional):
   - Terdapat kode debug pada baris 173-178 di blade view
   - Saat ini aktif untuk troubleshooting
   - Dapat di-comment jika sudah tidak diperlukan
   - Menampilkan: Raw JSON, Decoded data, Type, Empty status

2. Data Type Separation:
   - value (DECIMAL) - HANYA untuk operator numerik
   - value_json (TEXT) - HANYA untuk operator range
   - spec_value (VARCHAR) - HANYA untuk operator should_be
   - Pemisahan ini penting untuk menghindari data truncation error

3. JSON Encoding untuk Range:
   - Format: [{"min":"1","max":"2"},{"min":"5","max":"10"}]
   - Disimpan sebagai string di kolom value_json
   - Di-decode saat ditampilkan

4. Validation:
   - Operator should_be: required|string
   - Operator range: required|numeric untuk min dan max
   - Operator numerik: required|numeric

5. Model Relationship:
   - PENTING: Semua kolom pivot harus didefinisikan di withPivot()
   - Jika tidak, kolom tidak akan di-load oleh Eloquent
   - Ini adalah penyebab masalah "Range (No data)"


TIMELINE PERUBAHAN
-------------------

1. Fix PSR-4 autoloading error (RawMatCategory filename)
2. Diskusi dan implementasi operator should_be
3. Membuat migration untuk kolom spec_value
4. Update logic untuk menyimpan dan load spec_value
5. Error data truncation untuk range operator
6. Diskusi solusi untuk range operator
7. Membuat migration untuk kolom value_json
8. Update logic untuk menyimpan dan load value_json
9. Fix masalah display dengan menambahkan value_json ke withPivot()
10. Testing dan verifikasi semua operator berfungsi


DEVELOPER NOTES
---------------

Jika menambahkan kolom baru di pivot table:
1. Buat migration untuk menambahkan kolom
2. Jalankan php artisan migrate
3. Update model Reference.php - tambahkan kolom ke withPivot()
4. Update Livewire component - tambahkan property dan logic
5. Update blade view - tambahkan display logic

Jika terjadi error "Column not found" pada pivot:
- Cek apakah kolom sudah ada di database
- Cek apakah kolom sudah ditambahkan di withPivot() di model
- Cek apakah relationship sudah di-reload (refresh page)


REFERENSI FILE
--------------

Models:
- app/Models/Reference.php

Livewire Components:
- app/Livewire/Reference.php

Views:
- resources/views/livewire/reference.blade.php

Migrations:
- database/migrations/2025_10_31_135003_add_spec_value_to_specifications_table.php
- database/migrations/2025_10_31_153221_add_value_json_to_reference_specification_table.php


================================================================================
SELESAI
================================================================================
